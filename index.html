<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>AI Cam ‚Äì Smart Lens Detect + Tele</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system,Roboto,sans-serif;height:100dvh;display:flex;flex-direction:column}
.top-bar{background:#111;padding:10px;border-bottom:1px solid #333}
.row{display:flex;gap:8px;align-items:center}
select{flex:1;background:#222;color:#fff;border:1px solid #555;padding:6px;border-radius:6px}
.toggle{background:#222;border:1px solid #444;color:#aaa;padding:5px 10px;border-radius:12px;font-size:11px;cursor:pointer}
.toggle.active{border-color:#00d2ff;color:#00d2ff}
.viewport{flex:1;position:relative;background:#111;display:flex;align-items:center;justify-content:center}
video{width:100%;height:100%;object-fit:contain}
#status{position:absolute;top:10px;left:10px;font-size:11px;background:rgba(0,0,0,.6);padding:4px 10px;border-radius:12px}
.controls{background:#111;border-top:1px solid #333;padding:15px;display:flex;flex-direction:column;gap:15px;align-items:center}
.shutter{width:70px;height:70px;border-radius:50%;border:4px solid rgba(255,255,255,.3);background:radial-gradient(circle,#fff 30%,#00d2ff)}
#mask{position:absolute;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;flex-direction:column}
.spinner{width:40px;height:40px;border-radius:50%;border:3px solid #333;border-top:3px solid #00d2ff;animation:spin 1s linear infinite}
@keyframes spin{100%{transform:rotate(360deg)}}
canvas{display:none}
button.lensBtn{padding:4px 8px;border-radius:8px;border:1px solid #444;background:#222;color:#aaa;cursor:pointer;font-size:12px}
button.lensBtn.active{border-color:#00ff88;color:#00ff88}
</style>
</head>

<body>

<div class="top-bar">
  <div class="row">
    <select id="cameraSelect"></select>
    <select id="hdrCount" style="max-width:60px">
      <option value="3">3Âºµ</option>
      <option value="5">5Âºµ</option>
      <option value="7">7Âºµ</option>
    </select>
  </div>
  <div class="row">
    <button class="toggle active" id="hdrBtn">HDR</button>
    <button class="toggle" id="upscaleBtn">2x AI</button>
    <button class="toggle" id="pngBtn">PNG</button>
  </div>
  <div class="row" style="margin-top:5px">
    <button class="lensBtn" id="mainBtn">‰∏ªÊîù</button>
    <button class="lensBtn" id="tele3Btn">Èï∑ÁÑ¶ 3x</button>
    <button class="lensBtn" id="tele5Btn">Èï∑ÁÑ¶ 5x</button>
    <button class="lensBtn" id="wideBtn">Âª£Ëßí</button>
  </div>
</div>

<div class="viewport">
  <video id="video" autoplay playsinline muted></video>
  <div id="status">Init...</div>
  <div id="mask">
    <div class="spinner"></div>
    <div id="maskText">Processing...</div>
  </div>
</div>

<div class="controls">
  <div class="shutter" onclick="capture()"></div>
</div>

<canvas id="final"></canvas>
<canvas id="up"></canvas>

<script>
const video = document.getElementById("video");
const status = document.getElementById("status");
const cameraSelect = document.getElementById("cameraSelect");
const mask = document.getElementById("mask");
const maskText = document.getElementById("maskText");

let stream, track, imageCapture;
let lensMode = "main"; // main / tele3 / tele5 / wide
let devices = [];

document.querySelectorAll(".toggle").forEach(b=>{
  b.onclick=()=>b.classList.toggle("active");
});

// Lens buttons
document.getElementById("mainBtn").onclick=()=>switchLens("main");
document.getElementById("tele3Btn").onclick=()=>switchLens("tele3");
document.getElementById("tele5Btn").onclick=()=>switchLens("tele5");
document.getElementById("wideBtn").onclick=()=>switchLens("wide");

async function init(){
  await navigator.mediaDevices.getUserMedia({video:true});
  devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==="videoinput");
  cameraSelect.innerHTML="";
  devices.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.deviceId;
    o.text=d.label||"Camera";
    cameraSelect.appendChild(o);
  });
  cameraSelect.onchange=()=>detectAndLaunch(cameraSelect.value);
  detectAndLaunch(devices[devices.length-1].deviceId);
}

async function detectAndLaunch(id){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  status.innerText="Detecting lens...";
  
  const tmp = await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:id},width:640,height:480}});
  const caps = tmp.getVideoTracks()[0].getCapabilities();
  tmp.getTracks().forEach(t=>t.stop());

  const maxW = caps.width?.max || 0;

  if(maxW >= 4000){
    lensMode="main";
    launch(id,4096,3072,"üì∏ Main Camera");
  } else if(maxW >= 2000){
    lensMode="tele3";
    launch(id,1920,1080,"üî≠ Telephoto Camera 3x");
  } else {
    lensMode="wide";
    launch(id,640,480,"üåç Wide Camera");
  }
}

async function switchLens(mode){
  lensMode=mode;
  if(devices.length===0) return;

  // ÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÈè°È†≠‰ΩúÁÇ∫Âü∫Á§é
  let id = devices[devices.length-1].deviceId;
  let w=4096,h=3072,label="Main";

  if(mode==="main"){ w=4096; h=3072; label="üì∏ Main Camera";}
  if(mode==="tele3"){ w=1920; h=1080; label="üî≠ Telephoto 3x";}
  if(mode==="tele5"){ w=1920; h=1080; label="üî≠ Telephoto 5x";}
  if(mode==="wide"){ w=640; h=480; label="üåç Wide Camera";}

  launch(id,w,h,label);
}

async function launch(id,w,h,label){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:id},width:{ideal:w},height:{ideal:h}}});
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  imageCapture = window.ImageCapture ? new ImageCapture(track) : null;
  status.innerText = label;
}

async function capture(){
  mask.style.display="flex";
  maskText.innerText="Capturing...";
  const img = await grab();
  await finalize(img);
}

async function grab(){
  if(imageCapture){
    try{
      return await createImageBitmap(await imageCapture.takePhoto());
    }catch{}
  }
  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  return c;
}

async function finalize(src){
  const cvs=document.getElementById("final");
  cvs.width=src.width;
  cvs.height=src.height;
  cvs.getContext("2d").drawImage(src,0,0);

  const png=document.getElementById("pngBtn").classList.contains("active");
  const a=document.createElement("a");
  a.download=`IMG_${Date.now()}.${png?"png":"jpg"}`;
  a.href=cvs.toDataURL(png?"image/png":"image/jpeg",0.95);
  a.click();
  mask.style.display="none";
}

init();
</script>
</body>
</html>
