<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Pro Camera (HDR + SuperRes)</title>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar { 
            background: rgba(20,20,20,0.9); padding: 10px 15px; z-index: 20;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        select { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 15px; font-size: 13px; max-width: 150px;}

        /* å–æ™¯çª— */
        .viewport { flex-grow: 1; position: relative; background: #000; display:flex; justify-content:center; align-items:center; overflow:hidden;}
        video { width: 100%; height: 100%; object-fit: contain; }

        /* è™•ç†ä¸­æç¤º */
        #status-badge {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 165, 0, 0.9); color: black; padding: 10px 20px;
            border-radius: 30px; font-weight: bold; font-size: 14px;
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.5);
            display: none; z-index: 50; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls { 
            background: rgba(10,10,10,0.95); padding: 20px; 
            display: flex; flex-direction: column; gap: 20px; align-items: center; 
            padding-bottom: max(30px, env(safe-area-inset-bottom));
            border-top: 1px solid #222; z-index: 20;
        }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ•ç¾¤ */
        .mode-group {
            display: flex; gap: 5px; background: #222; padding: 4px; border-radius: 25px;
        }
        .mode-btn {
            padding: 8px 16px; border: none; background: transparent; color: #888; 
            font-size: 13px; font-weight: bold; cursor: pointer; border-radius: 20px;
            transition: 0.2s;
        }
        .mode-btn.active { color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* æ¨¡å¼é¡è‰²å®šç¾© */
        .mode-btn[data-mode="normal"].active { background: #fff; }
        .mode-btn[data-mode="super-res"].active { background: #00d2ff; }
        .mode-btn[data-mode="hdr"].active { background: #ffaa00; }

        /* è®Šç„¦ */
        .zoom-wrap { width: 90%; display: flex; align-items: center; gap: 10px; color: #ffd700; font-size: 14px; font-weight: bold;}
        input[type=range] { flex-grow: 1; accent-color: #ffd700; height: 4px; }

        /* å¿«é–€æŒ‰éˆ• (æœƒéš¨æ¨¡å¼è®Šè‰²) */
        .shutter-ring {
            width: 76px; height: 76px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: 0.2s;
        }
        .shutter-inner {
            width: 60px; height: 60px; border-radius: 50%; transition: 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .shutter-ring:active { transform: scale(0.95); }
        
        /* éš±è—ç•«å¸ƒ */
        canvas { display: none; }
    </style>
</head>
<body>

    <!-- æ¿¾é¡å®šç¾© -->
    <svg style="width:0;height:0;position:absolute;">
        <defs>
            <!-- éŠ³åŒ–æ¿¾é¡ -->
            <filter id="smart-sharpen"><feConvolveMatrix order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0"/></filter>
        </defs>
    </svg>

    <div class="top-bar">
        <select id="cameraSelect"><option>Loading...</option></select>
        <div id="resInfo" style="font-size:12px; color:#aaa;">Init...</div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="status-badge">è™•ç†ä¸­...</div>
    </div>

    <div class="controls">
        <!-- æ¨¡å¼åˆ‡æ› -->
        <div class="mode-group">
            <button class="mode-btn active" data-mode="normal" onclick="setMode('normal')">ä¸€èˆ¬</button>
            <button class="mode-btn" data-mode="super-res" onclick="setMode('super-res')">AI æ¸…æ™°</button>
            <button class="mode-btn" data-mode="hdr" onclick="setMode('hdr')">HDR</button>
        </div>

        <!-- è®Šç„¦ -->
        <div class="zoom-wrap">
            <span>1x</span>
            <input type="range" id="zoomSlider" min="1" max="8" step="0.1" value="1" disabled>
            <span id="zoomVal" style="width:30px; text-align:right;">1.0</span>
        </div>

        <!-- å¿«é–€ -->
        <div class="shutter-ring" onclick="capture()">
            <div class="shutter-inner" id="shutterInner" style="background:white;"></div>
        </div>
    </div>

    <canvas id="processCanvas"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const cameraSelect = document.getElementById('cameraSelect');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomVal = document.getElementById('zoomVal');
    const statusBadge = document.getElementById('status-badge');
    const shutterInner = document.getElementById('shutterInner');
    const resInfo = document.getElementById('resInfo');

    let currentStream = null;
    let videoTrack = null;
    let imageCapture = null;
    let currentMode = 'normal';

    // 1. åˆå§‹åŒ–
    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop());
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            cams.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `é¡é ­ ${i+1}`;
                cameraSelect.appendChild(opt);
            });

            if(cams.length > 0) {
                // é è¨­é¸æœ€å¾Œä¸€å€‹ (ä¸»æ”)
                const def = cams[cams.length - 1];
                cameraSelect.value = def.deviceId;
                startCamera(def.deviceId);
            }
            cameraSelect.onchange = (e) => startCamera(e.target.value);
        } catch(e) { alert("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™"); }
    }

    // 2. å•Ÿå‹•ç›¸æ©Ÿ
    async function startCamera(id) {
        if(currentStream) currentStream.getTracks().forEach(t => t.stop());
        zoomSlider.disabled = true;

        try {
            // å„ªå…ˆå˜—è©¦ 4K
            await launchStream({ video: { deviceId: { exact: id }, width: { ideal: 4096 }, height: { ideal: 4096 } } });
        } catch(e) {
            // é™ç´š
            try { await launchStream({ video: { deviceId: { exact: id } } }); } catch(err) {}
        }
    }

    async function launchStream(constraints) {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        if(window.ImageCapture) try{imageCapture = new ImageCapture(videoTrack)}catch(e){}

        video.onloadedmetadata = () => {
            resInfo.innerText = `${video.videoWidth}x${video.videoHeight}`;
            const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
            if(caps.zoom) {
                zoomSlider.disabled = false;
                zoomSlider.min = caps.zoom.min;
                zoomSlider.max = Math.min(caps.zoom.max, 8); // é™åˆ¶æœ€å¤§ 8 å€
                zoomSlider.step = 0.1;
                zoomSlider.value = 1;
                zoomSlider.oninput = function() {
                    zoomVal.innerText = parseFloat(this.value).toFixed(1);
                    videoTrack.applyConstraints({advanced:[{zoom:this.value}]});
                }
            }
        };
    }

    // 3. æ¨¡å¼åˆ‡æ›é‚è¼¯
    window.setMode = function(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => {
            b.classList.remove('active');
            if(b.dataset.mode === mode) b.classList.add('active');
        });

        // æ”¹è®Šå¿«é–€é¡è‰²
        if(mode === 'normal') shutterInner.style.background = 'white';
        else if(mode === 'super-res') shutterInner.style.background = '#00d2ff';
        else if(mode === 'hdr') shutterInner.style.background = '#ffaa00';
    }

    // 4. æ‹æ”ç¸½æ§
    window.capture = async function() {
        const btn = document.querySelector('.shutter-ring');
        btn.style.transform = 'scale(0.8)';
        setTimeout(() => btn.style.transform = 'scale(1)', 100);

        if(currentMode === 'normal') {
            await processNormal();
        } else if(currentMode === 'super-res') {
            await processSuperRes();
        } else if(currentMode === 'hdr') {
            await processHDR();
        }
    }

    // è¼”åŠ©ï¼šæŠ“åœ–
    async function grabImage() {
        if(imageCapture) {
            try { return await imageCapture.grabFrame(); } catch(e){}
        }
        const cvs = document.createElement('canvas');
        cvs.width = video.videoWidth; cvs.height = video.videoHeight;
        cvs.getContext('2d').drawImage(video,0,0);
        return cvs;
    }

    // --- æ¨¡å¼ A: ä¸€èˆ¬ ---
    async function processNormal() {
        const bmp = await grabImage();
        save(bmp, "Normal");
    }

    // --- æ¨¡å¼ B: AI è¶…æ¸…æ™° (ç–Šåœ–é™å™ª) ---
    async function processSuperRes() {
        statusBadge.innerText = "âš¡ AI é™å™ªé‹ç®—ä¸­...";
        statusBadge.style.display = 'block';
        statusBadge.style.background = 'rgba(0, 210, 255, 0.9)';
        
        try {
            const frames = [];
            // é€£æ‹ 4 å¼µ
            for(let i=0; i<4; i++) {
                frames.push(await grabImage());
                await new Promise(r => setTimeout(r, 20)); // å¾®å»¶é²
            }

            const w = frames[0].width;
            const h = frames[0].height;
            const canvas = document.getElementById('processCanvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');

            // å¹³å‡ç–ŠåŠ 
            frames.forEach((f, i) => {
                ctx.globalAlpha = 1 / (i + 1);
                ctx.drawImage(f, 0, 0);
            });
            ctx.globalAlpha = 1;

            // éŠ³åŒ–æ¿¾é¡
            applyFilter(ctx, w, h, 'url(#smart-sharpen) contrast(1.05)');
            
            save(canvas, "SuperRes");
        } catch(e) { alert("Error"); } 
        finally { statusBadge.style.display = 'none'; }
    }

    // --- æ¨¡å¼ C: HDR (é«˜å‹•æ…‹ç¯„åœ) ---
    async function processHDR() {
        statusBadge.innerText = "ğŸŒ HDR åˆæˆä¸­...";
        statusBadge.style.display = 'block';
        statusBadge.style.background = 'rgba(255, 170, 0, 0.9)';

        try {
            // æŠ“å–åŸåœ– (æœ€å¥½æŠ“å…©å¼µå–å¹³å‡æ¸›å°‘åŸºåº•é›œè¨Š)
            const base1 = await grabImage();
            await new Promise(r => setTimeout(r, 30));
            const base2 = await grabImage();

            const w = base1.width;
            const h = base1.height;
            const canvas = document.getElementById('processCanvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');

            // 1. åŸºåº•å±¤ (Base)
            ctx.drawImage(base1, 0, 0);
            ctx.globalAlpha = 0.5;
            ctx.drawImage(base2, 0, 0); // ç°¡å–®é™å™ª
            ctx.globalAlpha = 1;

            // 2. æ¨¡æ“¬ HDRï¼šæš—éƒ¨æäº®å±¤ (Shadow Lift)
            // åŸç†ï¼šä½¿ç”¨ Screen æ¨¡å¼ç–ŠåŠ åŒä¸€å¼µåœ–ï¼Œæœƒè®“é»‘è‰²è®Šé€ï¼Œç™½è‰²è®Šäº®ï¼Œæ•´é«”æäº®æš—éƒ¨
            const tempCvs = document.createElement('canvas');
            tempCvs.width = w; tempCvs.height = h;
            const tempCtx = tempCvs.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);

            ctx.globalCompositeOperation = 'screen'; 
            ctx.filter = 'brightness(0.6) contrast(1.1)'; // ä¸è¦å¤ªäº®ï¼Œåªéœ€è£œå…‰
            ctx.drawImage(tempCvs, 0, 0);
            
            // 3. æ¨¡æ“¬ HDRï¼šç´°ç¯€å¢å¼· (Local Contrast)
            // åŸç†ï¼šä½¿ç”¨ Soft-light æ¨¡å¼ç–ŠåŠ ï¼Œå¢åŠ å±¤æ¬¡æ„Ÿ
            ctx.globalCompositeOperation = 'soft-light';
            ctx.filter = 'saturate(1.2)'; // HDR é€šå¸¸è‰²å½©è¼ƒé£½å’Œ
            ctx.drawImage(tempCvs, 0, 0);

            // 4. é‡ç½®æ··åˆæ¨¡å¼
            ctx.globalCompositeOperation = 'source-over';
            ctx.filter = 'none';

            save(canvas, "HDR");

        } catch(e) { 
            console.error(e);
            alert("HDR è™•ç†å¤±æ•—"); 
        } finally { 
            statusBadge.style.display = 'none'; 
        }
    }

    // é€šç”¨å·¥å…·
    function applyFilter(ctx, w, h, filterStr) {
        const temp = document.createElement('canvas');
        temp.width = w; temp.height = h;
        temp.getContext('2d').drawImage(ctx.canvas, 0, 0);
        ctx.filter = filterStr;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(temp, 0, 0);
        ctx.filter = 'none';
    }

    function save(source, prefix) {
        const canvas = document.getElementById('processCanvas');
        if(source !== canvas) {
            canvas.width = source.width; canvas.height = source.height;
            canvas.getContext('2d').drawImage(source, 0, 0);
        }
        
        const link = document.createElement('a');
        link.download = `${prefix}_${Date.now()}.jpg`;
        // HDR èˆ‡ AI æ¨¡å¼ä½¿ç”¨æœ€é«˜å“è³ªå­˜æª”
        link.href = canvas.toDataURL('image/jpeg', 0.95);
        link.click();
    }

    init();
</script>
</body>
</html>


