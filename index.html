<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Camera Debug Mode</title>
    <style>
        body { 
            margin: 0; 
            background: #111; 
            font-family: monospace; 
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .video-wrapper {
            flex-grow: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            background: #222;
        }

        .controls {
            padding: 20px;
            background: #222;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:active { opacity: 0.8; }
        button.shoot { background: #dc3545; font-weight: bold; }

        /* é™¤éŒ¯è¨Šæ¯é¢æ¿ */
        #debug-log {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            pointer-events: none;
            white-space: pre-wrap;
            z-index: 20;
            border: 1px solid #444;
        }

        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warn { color: #fcc419; }

        input[type=range] { width: 100%; }
    </style>
</head>
<body>

    <div class="video-wrapper">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="debug-log">æº–å‚™å°±ç·’...<br>è‹¥ç•«é¢å…¨é»‘ï¼Œè«‹æŒ‰ä¸‹æ–¹ã€Œé‡å•Ÿç›¸æ©Ÿã€</div>
    </div>

    <div class="controls">
        <div style="display:flex; justify-content:space-between;">
            <span>è®Šç„¦: <span id="zoomVal">1.0</span>x</span>
        </div>
        <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" disabled>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="startCamera()">ğŸ”„ é‡å•Ÿç›¸æ©Ÿ</button>
            <button class="shoot" id="shutterBtn">ğŸ“¸ æ‹ç…§</button>
        </div>
    </div>
    
    <canvas id="photoCanvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const logDiv = document.getElementById('debug-log');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomVal = document.getElementById('zoomVal');
    const shutterBtn = document.getElementById('shutterBtn');
    
    let videoTrack;
    let imageCapture;

    function log(msg, type='') {
        const span = document.createElement('div');
        span.textContent = `> ${msg}`;
        if(type) span.className = type;
        logDiv.appendChild(span);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
    }

    async function startCamera() {
        log("é–‹å§‹åˆå§‹åŒ–ç›¸æ©Ÿ...", 'warn');
        
        // 1. æª¢æŸ¥æ˜¯å¦æ”¯æ´ API
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log("éŒ¯èª¤ï¼šç€è¦½å™¨ä¸æ”¯æ´ getUserMedia APIã€‚", 'error');
            log("æç¤ºï¼šè«‹ä½¿ç”¨ Chrome/Safariï¼Œä¸¦ç¢ºèªç¶²å€ç‚º https æˆ– localhost", 'warn');
            return;
        }

        // 2. è¨­å®šåƒæ•¸ (å…ˆæ”¾å¯¬æ¨™æº–ï¼Œæ±‚æœ‰ç•«é¢)
        const constraints = {
            audio: false,
            video: {
                // å˜—è©¦å¾Œé¡é ­ï¼Œä½†å…è¨±å¤±æ•—å›é€€
                facingMode: "environment", 
                width: { ideal: 4096 },
                height: { ideal: 4096 }
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            log("å–å¾—ä¸²æµæˆåŠŸï¼", 'success');
            
            video.srcObject = stream;
            
            // ç¢ºä¿ video æ’­æ”¾
            video.onloadedmetadata = () => {
                video.play().then(() => log("ç•«é¢æ’­æ”¾ä¸­", 'success'))
                            .catch(e => log("æ’­æ”¾å¤±æ•—(éœ€æ‰‹å‹•è§¸ç™¼): " + e, 'error'));
            };

            videoTrack = stream.getVideoTracks()[0];
            const settings = videoTrack.getSettings();
            log(`å¯¦éš›è§£æåº¦: ${settings.width}x${settings.height}`);
            
            // åˆå§‹åŒ–è®Šç„¦
            setupZoom();

            // åˆå§‹åŒ– ImageCapture
            if (window.ImageCapture) {
                imageCapture = new ImageCapture(videoTrack);
            }

        } catch (err) {
            log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err.name, 'error');
            log("è©³ç´°éŒ¯èª¤: " + err.message);
            
            if (err.name === 'NotAllowedError') {
                log("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼é€šå¸¸åœ¨ç¶²å€åˆ—å·¦å´æœ‰å€‹é–é ­æˆ–è¨­å®šåœ–ç¤ºã€‚", 'error');
            } else if (err.name === 'NotFoundError') {
                log("æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®ã€‚", 'error');
            } else {
                // å˜—è©¦æœ€åŸºæœ¬çš„ç›¸æ©Ÿè«‹æ±‚ (ä¸æŒ‡å®šè§£æåº¦èˆ‡é¡é ­æ–¹å‘)
                log("å˜—è©¦ä½¿ç”¨ç›¸å®¹æ¨¡å¼é‡è©¦...", 'warn');
                try {
                    const basicStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = basicStream;
                    videoTrack = basicStream.getVideoTracks()[0];
                    log("ç›¸å®¹æ¨¡å¼å•Ÿå‹•æˆåŠŸ", 'success');
                } catch (retryErr) {
                    log("ç›¸å®¹æ¨¡å¼ä¹Ÿå¤±æ•—: " + retryErr.message, 'error');
                }
            }
        }
    }

    function setupZoom() {
        const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
        
        if (capabilities.zoom) {
            zoomSlider.min = capabilities.zoom.min;
            zoomSlider.max = capabilities.zoom.max;
            zoomSlider.step = capabilities.zoom.step;
            zoomSlider.disabled = false;
            log(`æ”¯æ´è®Šç„¦: ${capabilities.zoom.min}x - ${capabilities.zoom.max}x`, 'success');
            
            zoomSlider.oninput = function() {
                const z = parseFloat(this.value);
                zoomVal.innerText = z.toFixed(1);
                videoTrack.applyConstraints({ advanced: [{ zoom: z }] });
            };
        } else {
            log("æ­¤è£ç½®/ç€è¦½å™¨ä¸æ”¯æ´ç¡¬é«”è®Šç„¦ API", 'warn');
        }
    }

    // æ‹ç…§
    shutterBtn.onclick = async () => {
        if (!videoTrack) {
            log("ç›¸æ©Ÿæœªå•Ÿå‹•ï¼Œç„¡æ³•æ‹ç…§", 'error');
            return;
        }
        
        log("æ‹ç…§ä¸­...");
        let blob = null;
        
        // å˜—è©¦ ImageCapture (é«˜ç•«è³ª)
        if (imageCapture) {
            try {
                blob = await imageCapture.takePhoto();
                log("ä½¿ç”¨ ImageCapture æ‹æ”æˆåŠŸ", 'success');
            } catch (e) {
                log("ImageCapture å¤±æ•—ï¼Œåˆ‡æ›æˆªåœ–æ¨¡å¼", 'warn');
            }
        }

        // å‚™ç”¨ï¼šæˆªåœ–æ¨¡å¼
        if (!blob) {
            const canvas = document.getElementById('photoCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
            log(`ä½¿ç”¨æˆªåœ–æ¨¡å¼: ${canvas.width}x${canvas.height}`);
        }

        // ä¸‹è¼‰
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Photo_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log("æª”æ¡ˆå·²ä¸‹è¼‰", 'success');
    };

    // è‡ªå‹•å•Ÿå‹•
    window.onload = startCamera;

</script>
</body>
</html>

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(bitmap, 0, 0);
                    
                    finalBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                } catch (e) {
                    console.log("ImageCapture å¤±æ•—ï¼Œåˆ‡æ›è‡³å‚™ç”¨æ–¹æ¡ˆ");
                }
            }

            // ç­–ç•¥ B: å¦‚æœç­–ç•¥ A å¤±æ•— (ä¾‹å¦‚åœ¨ iOS Safari)ï¼Œç›´æ¥æŠ“å– Video Frame
            if (!finalBlob) {
                width = video.videoWidth;
                height = video.videoHeight;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);
                finalBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            }

            // åŸ·è¡Œä¸‹è¼‰
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RAW_LIKE_${Date.now()}_${width}x${height}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            resInfo.innerText = `å·²å„²å­˜: ${width} x ${height} (PNGç„¡æ)`;

        } catch (error) {
            console.error(error);
            alert("æ‹æ”å¤±æ•—: " + error.message);
        }
    };

    // å•Ÿå‹•ç¨‹å¼
    initCamera();

</script>
</body>
</html>
