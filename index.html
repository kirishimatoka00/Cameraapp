<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Pro Camera (AI Edition)</title>
    <style>
        /* --- åŸºç¤ UI é¢¨æ ¼ --- */
        body { 
            margin: 0; 
            background: #000; 
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .top-bar {
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.4));
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
        }

        select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }

        /* æ™ºæ…§å¢å¼·é–‹é—œ */
        .enhance-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            background: rgba(0, 150, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(0, 150, 255, 0.5);
        }
        
        .enhance-toggle input { margin: 0; }
        .enhance-active { box-shadow: 0 0 10px rgba(0, 150, 255, 0.6); }

        /* è¦–çª—å€åŸŸ */
        .viewport {
            flex-grow: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls {
            background: rgba(0,0,0,0.8);
            padding: 20px 20px 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 20;
            backdrop-filter: blur(10px);
        }

        /* è®Šç„¦æ»‘æ¡¿ */
        .zoom-panel {
            width: 90%;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
        }
        
        input[type=range] {
            flex-grow: 1;
            height: 4px;
            background: #555;
            border-radius: 2px;
            accent-color: #ffd700;
        }

        /* å¿«é–€æŒ‰éˆ• */
        .shutter-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            position: relative;
            cursor: pointer;
            transition: 0.1s;
        }
        
        .shutter-btn::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60px; height: 60px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }
        
        .shutter-btn:active::after { 
            width: 50px; height: 50px; 
            background: #ccc;
        }

        /* Gemini AI é¢æ¿ */
        #gemini-panel {
            position: absolute;
            bottom: 150px; /* ä½æ–¼æ§åˆ¶å€ä¸Šæ–¹ */
            left: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 15px;
            display: none; /* é è¨­éš±è— */
            z-index: 30;
            color: #ccc;
            font-size: 13px;
        }
        
        #gemini-panel h3 { margin: 0 0 10px 0; color: #4facfe; font-size: 15px; display:flex; align-items:center; gap:5px;}
        #gemini-content { max-height: 100px; overflow-y: auto; line-height: 1.4; margin-bottom: 10px;}
        .api-input { width: 100%; padding: 8px; background:#111; border:1px solid #444; color:white; border-radius:4px; box-sizing: border-box; margin-bottom: 5px;}
        
        .btn-small {
            background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
        }
        .btn-gemini { background: linear-gradient(45deg, #4facfe, #00f2fe); color: #000; font-weight: bold; }

        /* SVG æ¿¾é¡ (éš±è—) */
        .svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>

    <!-- SVG æ¿¾é¡å®šç¾©ï¼šç”¨æ–¼ Canvas çš„æ™ºæ…§éŠ³åŒ– -->
    <svg class="svg-filters">
        <defs>
            <filter id="smart-sharpen">
                <!-- å·ç©çŸ©é™£éŠ³åŒ–æ¿¾é¡ -->
                <feConvolveMatrix order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0" preserveAlpha="true"/>
            </filter>
        </defs>
    </svg>

    <div class="top-bar">
        <select id="cameraSelect"><option>Loading...</option></select>
        
        <label class="enhance-toggle" id="enhanceLabel">
            <input type="checkbox" id="enhanceCheck" checked>
            <span>âœ¨ æ™ºæ…§å¢å¼·</span>
        </label>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div class="badge" id="resDisplay">ç­‰å¾…å•Ÿå‹•...</div>
    </div>

    <!-- Gemini AI é¢æ¿ -->
    <div id="gemini-panel">
        <h3>âœ¨ Gemini AI åˆ†æ</h3>
        <input type="password" id="apiKeyInput" class="api-input" placeholder="è²¼ä¸Š Gemini API Key (é¸å¡«)">
        <div id="gemini-content">è¼¸å…¥ Key å¾Œï¼Œæ‹ç…§æ™‚å°‡è‡ªå‹•åˆ†æç…§ç‰‡å“è³ª...</div>
        <div style="text-align: right;">
            <button class="btn-small" onclick="document.getElementById('gemini-panel').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <div class="controls">
        <div class="zoom-panel">
            <span>1.0x</span>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" disabled>
            <span id="zoomVal">1.0</span>
        </div>

        <div style="display:flex; gap:20px; align-items:center;">
            <button class="btn-small" onclick="document.getElementById('gemini-panel').style.display='block'">ğŸ¤– è¨­å®š AI</button>
            <div class="shutter-btn" id="shutterBtn"></div>
        </div>
    </div>

    <canvas id="photoCanvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const cameraSelect = document.getElementById('cameraSelect');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomVal = document.getElementById('zoomVal');
    const resDisplay = document.getElementById('resDisplay');
    const enhanceCheck = document.getElementById('enhanceCheck');
    const enhanceLabel = document.getElementById('enhanceLabel');
    const shutterBtn = document.getElementById('shutterBtn');
    
    // Gemini ç›¸é—œ
    const geminiPanel = document.getElementById('gemini-panel');
    const geminiContent = document.getElementById('gemini-content');
    const apiKeyInput = document.getElementById('apiKeyInput');

    let currentStream = null;
    let videoTrack = null;
    let imageCapture = null;

    // 1. åˆå§‹åŒ–
    async function init() {
        try {
            // è«‹æ±‚æ¬Šé™
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop());

            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');

            cameraSelect.innerHTML = '';
            videoDevices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Camera ${cameraSelect.length + 1}`;
                cameraSelect.appendChild(opt);
            });

            if (videoDevices.length > 0) {
                // å˜—è©¦é é¸å¾Œé¡é ­
                const backCam = videoDevices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                cameraSelect.value = backCam ? backCam.deviceId : videoDevices[videoDevices.length - 1].deviceId;
                startCamera(cameraSelect.value);
            }

            cameraSelect.onchange = (e) => startCamera(e.target.value);

            // UI äº’å‹•
            enhanceCheck.onchange = () => {
                if(enhanceCheck.checked) {
                    enhanceLabel.classList.add('enhance-active');
                    resDisplay.innerText += " (AI Ready)";
                } else {
                    enhanceLabel.classList.remove('enhance-active');
                }
            };

        } catch (e) {
            alert("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™");
        }
    }

    // 2. å•Ÿå‹•ç›¸æ©Ÿ (Max Res)
    async function startCamera(id) {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());

        try {
            const constraints = {
                video: {
                    deviceId: { exact: id },
                    width: { ideal: 4096 }, // å˜—è©¦ 4K
                    height: { ideal: 4096 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            currentStream = stream;
            video.srcObject = stream;
            videoTrack = stream.getVideoTracks()[0];

            if (window.ImageCapture) imageCapture = new ImageCapture(videoTrack);

            video.onloadedmetadata = () => {
                const w = video.videoWidth;
                const h = video.videoHeight;
                resDisplay.innerText = `Raw Res: ${w} x ${h}`;
                checkZoom();
            };
        } catch (e) {
            console.error(e);
        }
    }

    // 3. è®Šç„¦
    function checkZoom() {
        const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
        if (caps.zoom) {
            zoomSlider.disabled = false;
            zoomSlider.min = caps.zoom.min;
            zoomSlider.max = caps.zoom.max;
            zoomSlider.step = caps.zoom.step;
            
            zoomSlider.oninput = function() {
                zoomVal.innerText = parseFloat(this.value).toFixed(1) + 'x';
                videoTrack.applyConstraints({advanced: [{zoom: this.value}]});
            };
        } else {
            zoomSlider.disabled = true;
            zoomVal.innerText = "N/A";
        }
    }

    // 4. æ‹ç…§èˆ‡è™•ç† (æ ¸å¿ƒé‚è¼¯)
    shutterBtn.onclick = async () => {
        // UI å›é¥‹
        shutterBtn.style.transform = "scale(0.9)";
        setTimeout(() => shutterBtn.style.transform = "scale(1)", 100);

        let bitmap = null;
        
        try {
            // ç²å–å½±åƒ
            if (imageCapture) {
                try {
                    bitmap = await imageCapture.grabFrame();
                } catch(e) { console.log("grabFrame failed"); }
            }
            
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            let w, h;

            if (bitmap) {
                w = bitmap.width;
                h = bitmap.height;
                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(bitmap, 0, 0);
            } else {
                w = video.videoWidth;
                h = video.videoHeight;
                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(video, 0, 0);
            }

            // --- æ™ºæ…§å¢å¼·è™•ç† (Smart Enhance) ---
            if (enhanceCheck.checked) {
                resDisplay.innerText = "è™•ç†ä¸­: æ™ºæ…§éŠ³åŒ–...";
                
                // 1. æ‡‰ç”¨ SVG æ¿¾é¡åˆ° Context (é€™æ¯”æ‰‹å¯«è¿´åœˆå¿«å¾ˆå¤š)
                // æ³¨æ„ï¼šæŸäº›ç€è¦½å™¨å° Canvas filter æ”¯æ´åº¦ä¸ä¸€ï¼Œé€™è£¡ä½¿ç”¨æ¨™æº–èªæ³•
                ctx.filter = 'url(#smart-sharpen) contrast(1.1) saturate(1.1)';
                
                // ç‚ºäº†æ‡‰ç”¨æ¿¾é¡ï¼Œæˆ‘å€‘éœ€è¦æŠŠåŸæœ¬çš„åœ–å†ç•«ä¸€æ¬¡
                // å»ºç«‹ä¸€å€‹æš«å­˜çš„ canvas copy
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0);
                
                // æ¸…é™¤ä¸»ç•«å¸ƒä¸¦æ‡‰ç”¨æ¿¾é¡é‡ç¹ª
                ctx.clearRect(0, 0, w, h);
                ctx.drawImage(tempCanvas, 0, 0);
                
                // é‡ç½®æ¿¾é¡ä»¥å…å½±éŸ¿ä¸‹æ¬¡
                ctx.filter = 'none';
            }

            // --- å„²å­˜ç…§ç‰‡ ---
            const base64Image = canvas.toDataURL('image/jpeg', 0.95);
            
            const link = document.createElement('a');
            link.download = `AI_CAM_${Date.now()}.jpg`;
            link.href = base64Image;
            link.click();
            
            resDisplay.innerText = `å·²å„²å­˜ (${w}x${h})`;

            // --- Gemini AI åˆ†æ (å¦‚æœæœ‰çš„è©±) ---
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                geminiPanel.style.display = 'block';
                geminiContent.innerHTML = "ğŸ¤– Gemini æ­£åœ¨åˆ†æç…§ç‰‡å“è³ª...";
                analyzeImageWithGemini(base64Image, apiKey);
            }

        } catch (e) {
            alert("æ‹ç…§å¤±æ•—: " + e.message);
        }
    };

    // 5. Gemini API å‘¼å« (åŠŸèƒ½ï¼šåˆ†æèˆ‡å»ºè­°)
    async function analyzeImageWithGemini(base64Str, key) {
        // ç§»é™¤ Data URL å‰ç¶´
        const cleanBase64 = base64Str.replace(/^data:image\/(png|jpeg);base64,/, "");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
        
        const payload = {
            contents: [{
                parts: [
                    { text: "ä½œç‚ºå°ˆæ¥­æ”å½±å¸«ï¼Œè«‹ç°¡çŸ­åˆ†æé€™å¼µç…§ç‰‡çš„è§£æåº¦ã€å°ç„¦èˆ‡å…‰ç·šã€‚å¦‚æœæœ‰æ¨¡ç³Šæˆ–é›œè¨Šï¼Œè«‹çµ¦äºˆä¸€å€‹å…·é«”çš„æ”¹é€²å»ºè­° (ä¾‹å¦‚ï¼šæ‰‹æŒæ›´ç©©ã€å¢åŠ å…‰ç·š)ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œ50å­—ä»¥å…§ã€‚" },
                    { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                ]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            if (data.error) {
                geminiContent.innerHTML = `<span style="color:red">API éŒ¯èª¤: ${data.error.message}</span>`;
            } else {
                const text = data.candidates[0].content.parts[0].text;
                geminiContent.innerHTML = `<strong>ğŸ¤– åˆ†æå ±å‘Š:</strong><br>${text}`;
            }
        } catch (e) {
            geminiContent.innerHTML = `<span style="color:red">é€£ç·šå¤±æ•—</span>`;
        }
    }

    init();

</script>
</body>
</html>

