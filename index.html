<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Camera (Gemini 2.5 Flash)</title>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .top-bar { 
            background: rgba(20, 20, 30, 0.95); padding: 15px; border-bottom: 1px solid #444; 
            display: flex; flex-direction: column; gap: 12px; z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .row { display: flex; gap: 10px; width: 100%; align-items: center; }
        .label { font-size: 12px; color: #aaa; width: 60px; }
        
        /* è¼¸å…¥æ¡†èˆ‡é¸å–® */
        .api-input { flex-grow: 1; padding: 10px; background: #111; border: 1px solid #555; color: #0f0; border-radius: 6px; font-family: monospace; }
        select { flex-grow: 1; padding: 10px; background: #003366; border: 1px solid #00aaff; color: #fff; border-radius: 6px; font-weight: bold; }
        
        button { padding: 10px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; white-space: nowrap; transition: 0.2s;}
        .btn-scan { background: linear-gradient(135deg, #007bff, #00d2ff); color: #000; }
        .btn-scan:active { transform: scale(0.95); }
        
        .viewport { flex-grow: 1; position: relative; background: #000; display:flex; justify-content:center; align-items:center;}
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* ç‹€æ…‹èˆ‡ Log */
        #log-overlay {
            position: absolute; bottom: 120px; left: 15px; right: 15px;
            background: rgba(0,0,0,0.8); color: #00ff88; font-family: monospace; font-size: 13px;
            padding: 12px; border-radius: 8px; pointer-events: none;
            max-height: 120px; overflow-y: auto; border-left: 3px solid #00ff88;
            text-shadow: 1px 1px 1px black;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls { 
            background: #111; padding: 30px; display: flex; justify-content: center; align-items: center; 
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }
        
        .shutter-btn { 
            width: 76px; height: 76px; border-radius: 50%; border: 4px solid white; cursor: pointer; 
            background: transparent; position: relative; transition: 0.1s;
        }
        .shutter-btn::after { 
            content:''; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
            width:64px; height:64px; background:white; border-radius:50%; 
        }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-btn:active::after { background:#ccc; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="row">
            <span class="label">API Key</span>
            <input type="password" id="apiKey" class="api-input" placeholder="è²¼ä¸Š Key (AIza...)">
            <button class="btn-scan" onclick="scanModels()">ğŸ” æƒææ¨¡å‹</button>
        </div>
        <div class="row">
            <span class="label">ä½¿ç”¨æ¨¡å‹</span>
            <select id="modelSelect">
                <option value="" disabled selected>è«‹å…ˆæƒæ...</option>
            </select>
        </div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="log-overlay">ç³»çµ±å°±ç·’ã€‚<br>å»ºè­°ä½¿ç”¨ Gemini 2.5 Flash ä»¥ç²å¾—æœ€ä½³é€Ÿåº¦èˆ‡åˆ†æåŠ›ã€‚</div>
    </div>

    <div class="controls">
        <div class="shutter-btn" onclick="takePhoto()"></div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

<script>
    const logDiv = document.getElementById('log-overlay');
    const modelSelect = document.getElementById('modelSelect');
    const apiKeyInput = document.getElementById('apiKey');
    
    function log(msg) {
        logDiv.innerHTML = msg; 
        console.log(msg);
    }

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 4096 } } 
            });
            document.getElementById('videoPreview').srcObject = stream;
        } catch(e) { log("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e.message); }
    }
    initCamera();

    // æ ¸å¿ƒï¼šæƒæä¸¦å„ªå…ˆæ’åº Gemini 2.5
    async function scanModels() {
        const key = apiKeyInput.value.trim();
        if(!key) return log("âŒ è«‹å…ˆè¼¸å…¥ API Key");

        log("ğŸ”„ æ­£åœ¨æœå°‹ Gemini 2.5 Flash...");
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            
            if(data.error) return log(`âŒ API éŒ¯èª¤: ${data.error.message}`);
            if(!data.models) return log("âŒ æ‰¾ä¸åˆ°æ¨¡å‹åˆ—è¡¨");

            // 1. éæ¿¾å¯ç”¨æ¨¡å‹
            const validModels = data.models.filter(m => 
                m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
            );

            // 2. æ™ºæ…§æ’åºé‚è¼¯
            validModels.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                
                // å„ªå…ˆç´š 1: 2.5 Flash
                const is25FlashA = nameA.includes("gemini-2.5-flash");
                const is25FlashB = nameB.includes("gemini-2.5-flash");
                if (is25FlashA && !is25FlashB) return -1;
                if (!is25FlashA && is25FlashB) return 1;

                // å„ªå…ˆç´š 2: 1.5 Flash (å‚™æ¡ˆ)
                const is15FlashA = nameA.includes("gemini-1.5-flash");
                const is15FlashB = nameB.includes("gemini-1.5-flash");
                if (is15FlashA && !is15FlashB) return -1;
                if (!is15FlashA && is15FlashB) return 1;

                return 0;
            });

            // 3. å¡«å…¥é¸å–®
            modelSelect.innerHTML = '';
            validModels.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                
                // ç¾åŒ–é¡¯ç¤ºåç¨±
                let displayName = m.name.replace('models/', '');
                if (displayName.includes('gemini-2.5-flash')) {
                    displayName = `ğŸš€ ${displayName} (æœ€æ–°æ¨è–¦)`;
                    opt.style.fontWeight = "bold";
                    opt.style.color = "#00ff00"; // ç¶ è‰²é«˜äº®
                    opt.style.backgroundColor = "#002200";
                } else if (displayName.includes('flash')) {
                    displayName = `âš¡ ${displayName}`;
                }
                
                opt.text = displayName;
                modelSelect.appendChild(opt);
            });

            // 4. è‡ªå‹•é¸ä¸­ç¬¬ä¸€å€‹ (ç”±æ–¼æˆ‘å€‘æ’éåºï¼Œç¬¬ä¸€å€‹ä¸€å®šæ˜¯æœ€å„ªçš„ Flash)
            if(modelSelect.options.length > 0) {
                modelSelect.selectedIndex = 0;
                log(`âœ… å·²è‡ªå‹•é–å®šæœ€ä½³æ¨¡å‹ï¼š\n${modelSelect.options[0].text}`);
            }

        } catch(e) {
            log("âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        }
    }

    async function takePhoto() {
        const selectedModel = modelSelect.value;
        if(!selectedModel) return alert("è«‹å…ˆåŸ·è¡Œã€Œæƒææ¨¡å‹ã€ï¼");

        const video = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvas');
        const key = apiKeyInput.value.trim();

        // æ™ºèƒ½ç¸®åœ– (1024px å°æ–¼ 2.5 Flash ä¾†èªªå·²è¶³å¤ åˆ†æç´°ç¯€ä¸”çœæµé‡)
        const scale = Math.min(1024/video.videoWidth, 1024/video.videoHeight, 1);
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];

        // é¡¯ç¤ºä½¿ç”¨çš„æ¨¡å‹åç¨±
        const shortName = selectedModel.replace('models/', '');
        log(`ğŸ“· æ­£åœ¨ä½¿ç”¨ ${shortName} åˆ†æ...`);

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "ä½ æ˜¯å°ˆæ¥­æ”å½±å¸«ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡åˆ†æï¼š1.ç•«è³ªèˆ‡è§£æåº¦ 2.å…‰ç·šèˆ‡ç™½å¹³è¡¡ 3.å¦‚ä½•æ‹å¾—æ›´å¥½ (50å­—å…§)" },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ]
                    }]
                })
            });

            const data = await res.json();

            if(data.error) {
                log(`âŒ åˆ†æå¤±æ•—: ${data.error.message}`);
                // å¦‚æœ 2.5 å¤±æ•—ï¼Œæç¤ºç”¨æˆ¶æ› 1.5
                if (shortName.includes('2.5')) {
                    alert("Gemini 2.5 é¡åº¦å¯èƒ½å·²æ»¿æˆ–æœªé–‹é€šã€‚\nè«‹åœ¨ä¸Šæ–¹é¸å–®åˆ‡æ›å› '1.5 Flash' å†è©¦ä¸€æ¬¡ï¼");
                }
            } else {
                const text = data.candidates[0].content.parts[0].text;
                log("âœ… åˆ†æå®Œæˆï¼");
                alert(`ğŸ¤– ${shortName} åˆ†æå ±å‘Šï¼š\n\n` + text);
            }

        } catch(e) {
            log("âŒ ç¶²è·¯å‚³è¼¸éŒ¯èª¤");
        }
    }
</script>
</body>
</html>

