<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸æ©Ÿè¨ºæ–·ä¿®å¾©å·¥å…·</title>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background: #222; color: #fff; padding: 20px; }
        .box { background: #333; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
        h2 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin-right: 10px; margin-bottom: 10px;}
        .btn-safe { background: #28a745; color: white; }
        .btn-hd { background: #007bff; color: white; }
        .btn-stop { background: #dc3545; color: white; }
        
        #log { background: #000; color: #0f0; font-family: monospace; padding: 10px; height: 150px; overflow-y: scroll; border: 1px solid #555; }
        video { width: 100%; max-width: 500px; background: #000; display: block; margin-top: 10px; border: 2px solid #555; }
        
        .alert { background: #ff4444; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; font-weight: bold;}
        .success { color: #4caf50; }
        .error { color: #ff5252; }
    </style>
</head>
<body>

    <!-- åš´é‡éŒ¯èª¤è­¦å‘Šå€ -->
    <div id="file-protocol-alert" class="alert">
        âš ï¸ åµæ¸¬åˆ°åš´é‡ç’°å¢ƒéŒ¯èª¤ï¼<br><br>
        æ‚¨ç›®å‰æ­£åœ¨ä½¿ç”¨ <code>file://</code> æ¨¡å¼é–‹å•Ÿæª”æ¡ˆã€‚<br>
        ç€è¦½å™¨åŸºæ–¼å®‰å…¨ç†ç”±ï¼Œ<strong>ç¦æ­¢</strong>æ­¤æ¨¡å¼ä½¿ç”¨ç›¸æ©Ÿã€‚<br><br>
        <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
        1. é›»è…¦ç‰ˆï¼šè«‹ä½¿ç”¨ VS Code å®‰è£ "Live Server" æ’ä»¶é–‹å•Ÿã€‚<br>
        2. æ‰‹æ©Ÿç‰ˆï¼šè«‹å‹¿ç›´æ¥é»æ“Š HTML æª”æ¡ˆï¼Œæ‚¨å¿…é ˆå°‡æ­¤æª”æ¡ˆä¸Šå‚³åˆ°ç¶²ç«™ç©ºé–“ (å¦‚ GitHub Pages) æ‰èƒ½ä½¿ç”¨ã€‚
    </div>

    <div class="box">
        <h2>1. ç’°å¢ƒè¨ºæ–·</h2>
        <div id="env-status">æª¢æ¸¬ä¸­...</div>
    </div>

    <div class="box">
        <h2>2. ç›¸æ©Ÿæ“ä½œ</h2>
        <div style="margin-bottom: 10px;">
            å¦‚æœç•«é¢å…¨é»‘ï¼Œè«‹ä¾åºå˜—è©¦æŒ‰éˆ•ï¼š
        </div>
        <button class="btn-safe" onclick="startCamera('safe')">ğŸŸ¢ å•Ÿå‹• (å®‰å…¨æ¨¡å¼)</button>
        <button class="btn-hd" onclick="startCamera('hd')">ğŸ”µ å•Ÿå‹• (é«˜æ¸…/å¾Œé¡é ­)</button>
        <button class="btn-stop" onclick="stopCamera()">ğŸ›‘ åœæ­¢ç›¸æ©Ÿ</button>
        
        <video id="preview" autoplay playsinline muted></video>
        <div id="resolution-display">è§£æåº¦: æœªå•Ÿå‹•</div>
    </div>

    <div class="box">
        <h2>3. åŸ·è¡Œç´€éŒ„</h2>
        <div id="log">ç³»çµ±æº–å‚™å°±ç·’...</div>
    </div>

<script>
    const logBox = document.getElementById('log');
    const video = document.getElementById('preview');
    const resDisplay = document.getElementById('resolution-display');
    let currentStream = null;

    function log(msg, type = '') {
        const time = new Date().toLocaleTimeString();
        const colorClass = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
        logBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    // 1. ç’°å¢ƒè‡ªæˆ‘æª¢æ¸¬
    window.onload = function() {
        const protocol = window.location.protocol;
        const isSecure = window.isSecureContext;
        
        let statusHtml = `ç¶²å€é–‹é ­: <b>${protocol}</b><br>`;
        statusHtml += `å®‰å…¨ç’°å¢ƒ (Secure Context): <b>${isSecure ? 'æ˜¯ (PASS)' : 'å¦ (FAIL)'}</b><br>`;
        
        if (protocol === 'file:') {
            document.getElementById('file-protocol-alert').style.display = 'block';
            statusHtml += `<span class="error">âŒ éŒ¯èª¤ï¼šè«‹å‹¿ç›´æ¥é–‹å•Ÿæª”æ¡ˆï¼Œè«‹æ¶è¨­ Serverã€‚</span>`;
        } else if (!isSecure && protocol !== 'http:' && window.location.hostname !== 'localhost') {
            statusHtml += `<span class="error">âŒ éŒ¯èª¤ï¼šç›¸æ©Ÿéœ€è¦ HTTPS é€£ç·šã€‚</span>`;
        } else {
            statusHtml += `<span class="success">âœ… ç’°å¢ƒæª¢æŸ¥é€šéï¼Œæ‡‰è©²å¯ä»¥ä½¿ç”¨ç›¸æ©Ÿã€‚</span>`;
        }
        
        document.getElementById('env-status').innerHTML = statusHtml;
    };

    // 2. å•Ÿå‹•ç›¸æ©Ÿé‚è¼¯
    async function startCamera(mode) {
        stopCamera(); // å…ˆé—œé–‰èˆŠçš„
        log(`æ­£åœ¨å˜—è©¦å•Ÿå‹•ï¼š${mode === 'safe' ? 'å®‰å…¨æ¨¡å¼' : 'é«˜æ¸…æ¨¡å¼'}...`);

        const constraints = { audio: false };

        if (mode === 'safe') {
            // å®‰å…¨æ¨¡å¼ï¼šæœ€å¯¬é¬†çš„æ¢ä»¶ï¼Œåªæ±‚æœ‰ç•«é¢
            constraints.video = true;
        } else {
            // é«˜æ¸…æ¨¡å¼ï¼šå˜—è©¦å¾Œé¡é ­ + 4K
            constraints.video = {
                facingMode: "environment",
                width: { ideal: 4096 },
                height: { ideal: 4096 }
            };
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            currentStream = stream;
            video.srcObject = stream;
            
            // ç­‰å¾…ç•«é¢è¼‰å…¥ä»¥è®€å–è§£æåº¦
            video.onloadedmetadata = () => {
                const w = video.videoWidth;
                const h = video.videoHeight;
                resDisplay.innerText = `è§£æåº¦: ${w} x ${h}`;
                log(`âœ… æˆåŠŸå•Ÿå‹•ï¼å¯¦éš›è§£æåº¦: ${w}x${h}`, 'success');
                
                // æª¢æŸ¥æ˜¯å¦çœŸçš„æ‹¿åˆ°å¾Œé¡é ­
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                if (settings.facingMode) {
                    log(`ç›®å‰é¡é ­: ${settings.facingMode}`);
                }
            };

        } catch (err) {
            log(`âŒ å•Ÿå‹•å¤±æ•—: ${err.name}`, 'error');
            log(`åŸå› : ${err.message}`, 'error');
            
            if (err.name === 'NotAllowedError') {
                alert("æ‚¨æŒ‰äº†ã€Œæ‹’çµ•ã€æˆ–ç€è¦½å™¨æ¬Šé™è¢«å°é–ã€‚\nè«‹é‡æ•´ç¶²é ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚");
            } else if (err.name === 'OverconstrainedError' && mode === 'hd') {
                log("âš ï¸ ç¡¬é«”ä¸æ”¯æ´é«˜æ¸…è¨­å®šï¼Œè«‹æ”¹ç”¨ã€Œå®‰å…¨æ¨¡å¼ã€ã€‚", 'error');
                alert("æ‰‹æ©Ÿä¸æ”¯æ´æ­¤è§£æåº¦ï¼Œè«‹æ”¹æŒ‰ã€Œå®‰å…¨æ¨¡å¼ã€ã€‚");
            } else {
                alert("ç›¸æ©Ÿç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹çœ‹ä¸‹æ–¹ç´€éŒ„ã€‚");
            }
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            resDisplay.innerText = "è§£æåº¦: å·²åœæ­¢";
            log("ç›¸æ©Ÿå·²åœæ­¢");
        }
    }
</script>
</body>
</html>

