<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Camera (Zoom 1-8x)</title>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨æ§åˆ¶é¢æ¿ */
        .top-panel { 
            background: rgba(20, 20, 25, 0.95); padding: 10px; border-bottom: 1px solid #333; 
            display: flex; flex-direction: column; gap: 8px; z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .control-row { display: flex; gap: 10px; align-items: center; }
        .label { font-size: 12px; color: #aaa; width: 40px; white-space: nowrap; }
        
        select, input { 
            flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #555; 
            background: #111; color: white; font-size: 13px; outline: none;
        }
        
        .btn-scan { 
            background: linear-gradient(135deg, #007bff, #00d2ff); color: #000; font-weight: bold;
            border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; white-space: nowrap;
        }
        .btn-scan:active { transform: scale(0.95); }

        /* è¦–çª—èˆ‡ Log */
        .viewport { flex-grow: 1; position: relative; background: #000; display:flex; justify-content:center; align-items:center;}
        video { width: 100%; height: 100%; object-fit: contain; }
        
        #log-overlay {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: #00ff00; font-family: monospace; font-size: 12px;
            padding: 8px; border-radius: 5px; pointer-events: none;
            max-height: 80px; overflow-y: auto; text-shadow: 1px 1px 1px black;
        }

        /* åº•éƒ¨æ§åˆ¶å€ (å«è®Šç„¦) */
        .controls { 
            background: #111; padding: 15px 25px 30px 25px; 
            display: flex; flex-direction: column; gap: 20px; align-items: center; 
            z-index: 20;
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        /* è®Šç„¦ä»‹é¢ */
        .zoom-container {
            width: 100%; display: flex; align-items: center; gap: 15px;
            color: #ffd700; font-weight: bold; font-size: 14px;
        }
        
        input[type=range] {
            flex-grow: 1; height: 6px; border-radius: 3px; background: #444;
            accent-color: #ffd700; outline: none; -webkit-appearance: none;
        }
        
        /* å¿«é–€ */
        .shutter-btn { 
            width: 72px; height: 72px; border-radius: 50%; border: 4px solid white; cursor: pointer; 
            background: transparent; position: relative; transition: 0.1s;
        }
        .shutter-btn::after { 
            content:''; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
            width:62px; height:62px; background:white; border-radius:50%; 
        }
        .shutter-btn:active { transform: scale(0.92); }
        .shutter-btn:active::after { background:#ccc; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-panel">
        <div class="control-row">
            <span class="label">é¡é ­</span>
            <select id="cameraSelect"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <div class="control-row">
            <span class="label">Key</span>
            <input type="password" id="apiKey" placeholder="è²¼ä¸Š API Key">
            <button class="btn-scan" onclick="scanModels()">ğŸ” æƒæ</button>
        </div>
        <div class="control-row">
            <span class="label">æ¨¡å‹</span>
            <select id="modelSelect" style="background:#002244; border-color:#0088ff;">
                <option value="" disabled selected>è«‹å…ˆæƒæ...</option>
            </select>
        </div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="log-overlay">ç³»çµ±å°±ç·’ã€‚è«‹é¸æ“‡é¡é ­ã€‚</div>
    </div>

    <div class="controls">
        <!-- è®Šç„¦æ»‘æ¡¿ -->
        <div class="zoom-container">
            <span style="width:30px; text-align:center;">1x</span>
            <input type="range" id="zoomSlider" min="1" max="8" step="0.1" value="1" disabled>
            <span id="zoomVal" style="width:35px; text-align:right;">1.0</span>
        </div>

        <div class="shutter-btn" onclick="takePhoto()"></div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

<script>
    const logDiv = document.getElementById('log-overlay');
    const cameraSelect = document.getElementById('cameraSelect');
    const modelSelect = document.getElementById('modelSelect');
    const apiKeyInput = document.getElementById('apiKey');
    const video = document.getElementById('videoPreview');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomVal = document.getElementById('zoomVal');
    
    let currentStream = null;
    let videoTrack = null;

    function log(msg) {
        logDiv.innerHTML = msg; 
        console.log(msg);
    }

    // 1. åˆå§‹åŒ–é¡é ­åˆ—è¡¨
    async function initCameraList() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop());

            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            cams.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Camera ${i}`;
                cameraSelect.appendChild(opt);
            });

            if(cams.length > 0) {
                // é è¨­é¸æœ€å¾Œä¸€å€‹ (é€šå¸¸æ˜¯ä¸»æ”)
                const defaultCam = cams[cams.length - 1];
                cameraSelect.value = defaultCam.deviceId;
                startCamera(defaultCam.deviceId);
            }
            cameraSelect.onchange = (e) => startCamera(e.target.value);

        } catch(e) { log("âŒ ç„¡ç›¸æ©Ÿæ¬Šé™"); }
    }

    // 2. å•Ÿå‹•é¡é ­ & è¨­å®šè®Šç„¦
    async function startCamera(deviceId) {
        if(currentStream) currentStream.getTracks().forEach(t => t.stop());
        zoomSlider.disabled = true; // åˆ‡æ›æ™‚å…ˆåœç”¨è®Šç„¦

        try {
            // å˜—è©¦é«˜ç•«è³ª
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { deviceId: { exact: deviceId }, width: { ideal: 4096 }, height: { ideal: 4096 } } 
            });
            setupVideo(stream, "HDæ¨¡å¼");
        } catch(e) {
            log("âš ï¸ åˆ‡æ›è‡³æ¨™æº–æ¨¡å¼");
            try {
                // é™ç´šé‡è©¦
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { deviceId: { exact: deviceId } } 
                });
                setupVideo(stream, "æ¨™æº–æ¨¡å¼");
            } catch(e2) { log("âŒ é¡é ­ç„¡æ³•å•Ÿå‹•"); }
        }
    }

    function setupVideo(stream, mode) {
        video.srcObject = stream;
        currentStream = stream;
        videoTrack = stream.getVideoTracks()[0];
        
        video.onloadedmetadata = () => {
            const w = video.videoWidth;
            const h = video.videoHeight;
            log(`âœ… å·²å•Ÿå‹• (${mode}): ${w}x${h}`);
            
            // è¨­å®šè®Šç„¦èƒ½åŠ›
            const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
            if (caps.zoom) {
                zoomSlider.disabled = false;
                zoomSlider.min = caps.zoom.min;
                // è¨­å®šæœ€å¤§å€¼ï¼šå– (ç¡¬é«”æ¥µé™) èˆ‡ (ä½¿ç”¨è€…è¦æ±‚çš„ 8å€) å…©è€…è¼ƒå°è€…
                zoomSlider.max = Math.min(caps.zoom.max, 8); 
                zoomSlider.step = 0.1; // ç´°ç·»å¾®èª¿
                zoomSlider.value = 1;
                zoomVal.innerText = "1.0";
                
                // é¡¯ç¤ºå¯¦éš›æ”¯æ´ç¯„åœ
                log(`ğŸ” è®Šç„¦æ”¯æ´: ${zoomSlider.min}x - ${zoomSlider.max}x`);

                zoomSlider.oninput = function() {
                    const val = parseFloat(this.value);
                    zoomVal.innerText = val.toFixed(1);
                    videoTrack.applyConstraints({advanced: [{zoom: val}]})
                        .catch(e => console.log("Zoom fail", e));
                };
            } else {
                zoomSlider.disabled = true;
                zoomVal.innerText = "N/A";
                log("âš ï¸ æ­¤é¡é ­ä¸æ”¯æ´ç¡¬é«”è®Šç„¦");
            }
        };
    }

    // 3. AI æ¨¡å‹æƒæ
    async function scanModels() {
        const key = apiKeyInput.value.trim();
        if(!key) return log("âŒ è«‹è¼¸å…¥ Key");
        log("ğŸ”„ æƒæä¸­...");
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            
            if(data.error) return log(`âŒ ${data.error.message}`);
            
            const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
            
            // æ’åº: 2.5 Flash ç¬¬ä¸€
            validModels.sort((a, b) => {
                const nA = a.name, nB = b.name;
                if (nA.includes("2.5-flash") && !nB.includes("2.5-flash")) return -1;
                if (!nA.includes("2.5-flash") && nB.includes("2.5-flash")) return 1;
                return 0;
            });

            modelSelect.innerHTML = '';
            validModels.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                let t = m.name.replace('models/', '');
                if (t.includes('2.5-flash')) t = `ğŸš€ ${t}`;
                else if (t.includes('flash')) t = `âš¡ ${t}`;
                opt.text = t;
                modelSelect.appendChild(opt);
            });
            if(modelSelect.options.length > 0) {
                modelSelect.selectedIndex = 0;
                log(`âœ… å·²é–å®š: ${modelSelect.options[0].text}`);
            }
        } catch(e) { log("âŒ é€£ç·šéŒ¯èª¤"); }
    }

    // 4. æ‹ç…§
    async function takePhoto() {
        const selectedModel = modelSelect.value;
        const key = apiKeyInput.value.trim();
        if(!selectedModel) return alert("è«‹å…ˆæƒææ¨¡å‹ï¼");

        const canvas = document.getElementById('canvas');
        // ç¸®åœ–è‡³ 1024px ä»¥åŠ é€Ÿ AI
        const scale = Math.min(1024/video.videoWidth, 1024/video.videoHeight, 1);
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const base64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
        const shortName = selectedModel.replace('models/', '');
        
        log(`ğŸ“· å‚³é€ä¸­ (${shortName})...`);

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "è«‹åˆ†æç…§ç‰‡ï¼š1.ç•«è³ª 2.å…‰ç·š 3.å»ºè­° (ç¹é«”ä¸­æ–‡, 50å­—å…§)" },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ]
                    }]
                })
            });
            const data = await res.json();
            if(data.error) {
                log("âŒ åˆ†æå¤±æ•—");
                alert(data.error.message);
            } else {
                log("âœ… åˆ†æå®Œæˆ");
                alert(data.candidates[0].content.parts[0].text);
            }
        } catch(e) { log("âŒ ç¶²è·¯éŒ¯èª¤"); }
    }
    
    initCameraList();
</script>
</body>
</html>

