<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Camera (Universal)</title>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨å·¥å…·åˆ— */
        .top-bar { 
            background: rgba(0,0,0,0.8); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: absolute; 
            top: 0; left: 0; right: 0; 
            z-index: 10; 
        }
        
        select { 
            background: #222; 
            color: #fff; 
            border: 1px solid #555; 
            padding: 8px; 
            border-radius: 8px; 
            font-size: 14px; 
            max-width: 60%;
        }

        /* è¦–çª—å€åŸŸ */
        .viewport { flex-grow: 1; position: relative; background: #111; display:flex; justify-content:center; align-items:center;}
        video { width: 100%; height: 100%; object-fit: contain; }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-badge {
            position: absolute;
            top: 70px;
            right: 15px;
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #ccc;
            pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls { 
            background: rgba(0,0,0,0.9); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            z-index: 10; 
        }

        /* è®Šç„¦ */
        .zoom-container { display:flex; gap:10px; align-items:center; width: 100%; }
        input[type=range] { flex-grow: 1; height:20px; }

        /* å¿«é–€ */
        .shutter-group { display:flex; justify-content:space-between; align-items:center; width:100%; }
        .shutter-btn { 
            width: 70px; height: 70px; 
            border-radius: 50%; 
            border: 4px solid white; 
            cursor: pointer; 
            position: relative; 
            background: transparent;
        }
        .shutter-btn::after { 
            content:''; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
            width:60px; height:60px; background:white; border-radius:50%; transition:0.1s;
        }
        .shutter-btn:active::after { transform:translate(-50%,-50%) scale(0.9); background:#ccc; }

        /* Gemini é¢æ¿ */
        #gemini-panel { 
            position: absolute; bottom: 130px; left: 15px; right: 15px; 
            background: rgba(30,30,35,0.95); 
            border: 1px solid #4facfe; 
            border-radius: 12px; 
            padding: 15px; 
            display: none; 
            z-index: 20; 
        }
        .api-input { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white; margin-bottom: 10px; box-sizing: border-box; border-radius: 5px;}
        #gemini-text { font-size: 13px; color: #ddd; max-height: 120px; overflow-y: auto; line-height: 1.5; }
        .close-btn { float: right; background: #555; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- éš±è—çš„ SVG æ¿¾é¡ (æ™ºæ…§å¢å¼·ç”¨) -->
    <svg style="width:0;height:0;position:absolute;">
        <defs><filter id="smart-sharpen"><feConvolveMatrix order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0"/></filter></defs>
    </svg>

    <div class="top-bar">
        <select id="cameraSelect"><option>è¼‰å…¥ä¸­...</option></select>
        <div style="font-size:12px; display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="enhanceCheck" checked> <span>AIå¢å¼·</span>
        </div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="statusInfo" class="status-badge">ç­‰å¾…å•Ÿå‹•...</div>
    </div>

    <!-- Gemini åˆ†æçµæœè¦–çª— -->
    <div id="gemini-panel">
        <strong style="color:#4facfe;">ğŸ¤– Gemini åˆ†æå ±å‘Š</strong>
        <button class="close-btn" onclick="this.parentElement.style.display='none'">é—œé–‰</button>
        <div style="margin-top:10px;">
            <input type="password" id="apiKey" class="api-input" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Gemini API Key">
            <div id="gemini-text">æ‹ç…§å¾Œå°‡è‡ªå‹•åˆ†æ...</div>
        </div>
    </div>

    <div class="controls">
        <div class="zoom-container">
            <span style="font-size:12px; width:30px;">1.0x</span>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" disabled>
        </div>
        
        <div class="shutter-group">
            <button onclick="document.getElementById('gemini-panel').style.display='block'" style="background:none; border:1px solid #666; color:#aaa; padding:8px; border-radius:5px; font-size:12px;">âš™ï¸ è¨­å®šKey</button>
            <div class="shutter-btn" id="shutterBtn"></div>
            <div style="width:50px;"></div> <!-- ä½”ä½ç¬¦ï¼Œè®“å¿«é–€ç½®ä¸­ -->
        </div>
    </div>

    <canvas id="photoCanvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const cameraSelect = document.getElementById('cameraSelect');
    const statusInfo = document.getElementById('statusInfo');
    const zoomSlider = document.getElementById('zoomSlider');
    const shutterBtn = document.getElementById('shutterBtn');
    
    // Gemini ç›¸é—œ
    const geminiPanel = document.getElementById('gemini-panel');
    const geminiText = document.getElementById('gemini-text');
    const apiKeyInput = document.getElementById('apiKey');

    let currentStream = null;
    let videoTrack = null;
    let imageCapture = null;

    // 1. åˆå§‹åŒ–ä¸¦åˆ—å‡ºé¡é ­
    async function init() {
        try {
            // è«‹æ±‚æ¬Šé™
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop());

            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            cams.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Camera ${i} (ç„¡åç¨±)`;
                cameraSelect.appendChild(opt);
            });

            if (cams.length > 0) {
                // é è¨­é¸æ“‡æœ€å¾Œä¸€å€‹é¡é ­ (é€šå¸¸æ˜¯ä¸»æ”)
                // ä¿®æ­£ï¼šå¦‚æœ cameraSelect.value ç‚ºç©ºï¼Œå¼·åˆ¶é¸æœ€å¾Œä¸€å€‹
                const defaultCam = cams[cams.length - 1];
                cameraSelect.value = defaultCam.deviceId;
                startCamera(defaultCam.deviceId);
            }
            
            cameraSelect.onchange = (e) => startCamera(e.target.value);

        } catch (e) {
            alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™");
        }
    }

    // 2. å•Ÿå‹•é¡é ­ (é—œéµä¿®æ­£ï¼šè‡ªå‹•é™ç´šé‚è¼¯)
    async function startCamera(deviceId) {
        // å…ˆåœæ­¢èˆŠçš„
        if (currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
        }

        statusInfo.innerText = "å•Ÿå‹•ä¸­ (å˜—è©¦é«˜ç•«è³ª)...";
        zoomSlider.disabled = true;

        // å®šç¾©å…©ç¨®ç­–ç•¥
        const highResConstraints = {
            video: {
                deviceId: { exact: deviceId },
                width: { ideal: 4096 }, // å˜—è©¦ 4K
                height: { ideal: 4096 }
            }
        };

        const fallbackConstraints = {
            video: {
                deviceId: { exact: deviceId } // åªè¦æ±‚è©²é¡é ­ï¼Œä¸é™ç•«è³ª
            }
        };

        try {
            // å˜—è©¦ç­–ç•¥ A: é«˜ç•«è³ª
            await launchStream(highResConstraints, "HD æ¨¡å¼");
        } catch (err) {
            console.warn("é«˜ç•«è³ªå•Ÿå‹•å¤±æ•—ï¼Œåˆ‡æ›ç›¸å®¹æ¨¡å¼...", err);
            try {
                // å˜—è©¦ç­–ç•¥ B: ç›¸å®¹æ¨¡å¼ (è§£æ±º Camera 2 é»‘ç•«é¢å•é¡Œ)
                statusInfo.innerText = "åˆ‡æ›è‡³ç›¸å®¹æ¨¡å¼...";
                await launchStream(fallbackConstraints, "æ¨™æº–æ¨¡å¼");
            } catch (fatalErr) {
                statusInfo.innerText = "å•Ÿå‹•å¤±æ•—";
                alert("æ­¤é¡é ­ç„¡æ³•å•Ÿå‹•: " + fatalErr.message);
            }
        }
    }

    // è¼”åŠ©å‡½å¼ï¼šåŸ·è¡Œ getUserMedia
    async function launchStream(constraints, modeLabel) {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        
        // å˜—è©¦ ImageCapture
        if (window.ImageCapture) {
            try { imageCapture = new ImageCapture(videoTrack); } catch(e){}
        }

        // ç­‰å¾…å½±ç‰‡è¼‰å…¥
        video.onloadedmetadata = () => {
            const w = video.videoWidth;
            const h = video.videoHeight;
            statusInfo.innerText = `${modeLabel}: ${w}x${h}`;
            
            // æª¢æŸ¥è®Šç„¦
            const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
            if (caps.zoom) {
                zoomSlider.disabled = false;
                zoomSlider.min = caps.zoom.min;
                zoomSlider.max = caps.zoom.max;
                zoomSlider.step = caps.zoom.step;
                zoomSlider.value = 1;
                // é‡è¨­è®Šç„¦äº‹ä»¶
                zoomSlider.oninput = function() {
                    videoTrack.applyConstraints({advanced: [{zoom: this.value}]});
                };
            } else {
                zoomSlider.disabled = true;
            }
        };
    }

    // 3. æ‹ç…§èˆ‡ Gemini åˆ†æ
    shutterBtn.onclick = async () => {
        shutterBtn.style.opacity = 0.5;
        setTimeout(() => shutterBtn.style.opacity = 1, 150);

        try {
            let bitmap;
            // å„ªå…ˆå˜—è©¦ grabFrame (é«˜ç•«è³ª)
            if (imageCapture) {
                try { bitmap = await imageCapture.grabFrame(); } catch(e) {}
            }

            const canvas = document.getElementById('photoCanvas');
            const w = bitmap ? bitmap.width : video.videoWidth;
            const h = bitmap ? bitmap.height : video.videoHeight;
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');

            // ç¹ªè£½
            if (bitmap) ctx.drawImage(bitmap, 0, 0);
            else ctx.drawImage(video, 0, 0);

            // æ™ºæ…§å¢å¼·è™•ç†
            if (document.getElementById('enhanceCheck').checked) {
                ctx.filter = 'url(#smart-sharpen) contrast(1.1)';
                const temp = document.createElement('canvas'); temp.width = w; temp.height = h;
                temp.getContext('2d').drawImage(canvas, 0, 0);
                ctx.clearRect(0, 0, w, h);
                ctx.drawImage(temp, 0, 0);
                ctx.filter = 'none';
            }

            // å­˜æª” (JPG Q90)
            const base64 = canvas.toDataURL('image/jpeg', 0.9);
            const a = document.createElement('a');
            a.href = base64;
            a.download = `Photo_${Date.now()}.jpg`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);

            // å‘¼å« Gemini (å¦‚æœæœ‰ Key)
            const key = apiKeyInput.value.trim();
            if (key) {
                geminiPanel.style.display = 'block';
                geminiText.innerHTML = "ğŸ”„ æ­£åœ¨å‚³é€è‡³ Gemini...";
                callGemini(base64, key);
            }

        } catch (e) {
            alert("æ‹ç…§å¤±æ•—: " + e.message);
        }
    };

    // å‘¼å« Gemini API (ä½¿ç”¨æœ€æ–°çš„ flash-latest)
    async function callGemini(base64Str, key) {
        const cleanBase64 = base64Str.replace(/^data:image\/(png|jpeg);base64,/, "");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${key}`;
        
        const payload = {
            contents: [{
                parts: [
                    { text: "è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­åˆ†æé€™å¼µç…§ç‰‡çš„æ¸…æ™°åº¦ã€å…‰ç·šèˆ‡å°ç„¦ç‹€æ³ï¼Œä¸¦çµ¦å‡ºæ”¹é€²å»ºè­°ã€‚" },
                    { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                ]
            }]
        };

        try {
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.error) {
                // å¦‚æœå¤±æ•—ï¼Œå˜—è©¦èˆŠç‰ˆæ¨¡å‹
                if(data.error.code === 404) {
                    geminiText.innerText = "å˜—è©¦ç›¸å®¹æ¨¡å‹...";
                    callGeminiLegacy(cleanBase64, key);
                } else {
                    geminiText.innerHTML = `<span style="color:#ff6666">${data.error.message}</span>`;
                }
            } else {
                geminiText.innerText = data.candidates[0].content.parts[0].text;
            }
        } catch (e) {
            geminiText.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
        }
    }

    async function callGeminiLegacy(cleanBase64, key) {
        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{text: "åˆ†æç…§ç‰‡æ¸…æ™°åº¦"}, {inline_data: {mime_type: "image/jpeg", data: cleanBase64}}] }]
                })
            });
            const data = await res.json();
            if(data.error) geminiText.innerText = "ç„¡æ³•åˆ†æ (Key éŒ¯èª¤æˆ–æ¨¡å‹ä¸æ”¯æ´)";
            else geminiText.innerText = data.candidates[0].content.parts[0].text;
        } catch(e) { geminiText.innerText = "API éŒ¯èª¤"; }
    }

    init();
</script>
</body>
</html>

