<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web GCam Simulator (Telephoto)</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; height: 100vh; overflow: hidden; }
        video { width: 100%; max-height: 70vh; object-fit: cover; }
        .controls { padding: 20px; width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.5); position: absolute; bottom: 0; }
        select, button, input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: none; font-size: 16px; }
        button { background: #3498db; color: white; font-weight: bold; cursor: pointer; }
        button:active { background: #2980b9; }
        .slider-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        label { width: 80px; font-size: 12px; }
        input[type=range] { flex-grow: 1; }
        
        /* æ¨¡æ“¬ GCam é¢¨æ ¼çš„ CSS æ¿¾é¡é¡åˆ¥ */
        .gcam-style {
            /* æ ¹æ“š XML ä¸­çš„ lib_saturation å’Œ lib_contrast æ¦‚å¿µé€²è¡Œæ¨¡æ“¬ */
            filter: contrast(1.1) saturate(1.2) brightness(1.05);
        }
    </style>
</head>
<body>

    <video id="cameraPreview" autoplay playsinline class="gcam-style"></video>

    <div class="controls">
        <select id="cameraSelect">
            <option value="">æ­£åœ¨å°‹æ‰¾é¡é ­...</option>
        </select>

        <div class="slider-group">
            <label>æ›å…‰ (EV)</label>
            <input type="range" id="evSlider" min="-2" max="2" step="0.1" value="0.6">
        </div>

        <button id="shutterBtn">æ‹ç…§ (Capture)</button>
    </div>

    <canvas id="photoCanvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('cameraPreview');
        const cameraSelect = document.getElementById('cameraSelect');
        const evSlider = document.getElementById('evSlider');
        const shutterBtn = document.getElementById('shutterBtn');
        const canvas = document.getElementById('photoCanvas');
        
        let currentStream = null;
        let videoTrack = null;
        let capabilities = {};

        // 1. åˆå§‹åŒ–ä¸¦å–å¾—ç›¸æ©Ÿåˆ—è¡¨
        async function initCamera() {
            try {
                // å…ˆè«‹æ±‚ä¸€æ¬¡æ¬Šé™ä»¥åˆ—å‡ºè©³ç´°æ¨™ç±¤
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    // å˜—è©¦è¾¨è­˜é•·ç„¦é¡é ­é—œéµå­—
                    let label = device.label || `Camera ${cameraSelect.length + 1}`;
                    if (label.toLowerCase().includes('tele') || label.toLowerCase().includes('zoom')) {
                        label = "ğŸ”­ " + label; // æ¨™è¨˜é•·ç„¦
                    }
                    option.text = label;
                    cameraSelect.appendChild(option);
                });

                // é è¨­é¸æ“‡æœ€å¾Œä¸€å€‹é¡é ­ï¼ˆåœ¨å¾ˆå¤šæ‰‹æ©Ÿä¸Šé•·ç„¦é€šå¸¸æ’åœ¨å¾Œé¢ï¼Œæˆ–è€…æ ¹æ“š XML ID 2 æ¨æ¸¬ï¼‰
                if (videoDevices.length > 0) {
                    cameraSelect.selectedIndex = videoDevices.length - 1;
                    startStream(videoDevices[videoDevices.length - 1].deviceId);
                }

            } catch (err) {
                console.error("Camera Access Error:", err);
                alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™");
            }
        }

        // 2. å•Ÿå‹•å½±åƒä¸²æµ
        async function startStream(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    deviceId: { exact: deviceId },
                    width: { ideal: 3840 }, // å˜—è©¦ 4K
                    height: { ideal: 2160 },
                    advanced: [{ focusMode: 'continuous' }] // å˜—è©¦å•Ÿç”¨é€£çºŒå°ç„¦
                }
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                videoTrack = currentStream.getVideoTracks()[0];
                
                // å–å¾—ç¡¬é«”èƒ½åŠ›ï¼ˆæª¢æŸ¥æ˜¯å¦æ”¯æ´ EV èª¿æ•´ï¼‰
                capabilities = videoTrack.getCapabilities();
                updateEV(evSlider.value); // å¥—ç”¨é è¨­ EV
                
            } catch (err) {
                console.error("Stream Error:", err);
            }
        }

        // 3. èª¿æ•´æ›å…‰è£œå„Ÿ (å°æ‡‰ XML: pref_exposure_compensation_key)
        async function updateEV(value) {
            if (videoTrack && capabilities.exposureCompensation) {
                try {
                    await videoTrack.applyConstraints({
                        advanced: [{ exposureCompensation: parseFloat(value) }]
                    });
                    console.log(`EV set to ${value}`);
                } catch (err) {
                    console.warn("EV adjustment failed", err);
                }
            } else {
                console.log("Device does not support direct EV control via Web API");
                // å‚™æ¡ˆï¼šå¦‚æœç¡¬é«”ä¸æ”¯æ´ EVï¼Œå¯ä»¥ç”¨ CSS brightness æ¨¡æ“¬
                // video.style.filter = `brightness(${1 + parseFloat(value)/5})`; 
            }
        }

        // ç›£è½äº‹ä»¶
        cameraSelect.addEventListener('change', (e) => startStream(e.target.value));
        evSlider.addEventListener('input', (e) => updateEV(e.target.value));

        // 4. æ‹ç…§è™•ç† (åŒ…å«æ¨¡æ“¬ GCam çš„é¢¨æ ¼è™•ç†)
        shutterBtn.addEventListener('click', () => {
            if (!currentStream) return;

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // æ¨¡æ“¬ XML é¢¨æ ¼ï¼šå¥—ç”¨æ¿¾é¡åˆ° Canvas Context
            // XML: lib_saturation_key (é«˜é£½å’Œ), lib_gamma (å°æ¯”èª¿æ•´)
            ctx.filter = 'contrast(1.1) saturate(1.2) brightness(1.05)';
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // è¼¸å‡ºåœ–ç‰‡
            const dataURL = canvas.toDataURL('image/jpeg', 0.95);
            
            // ä¸‹è¼‰
            const link = document.createElement('a');
            link.download = `GCam_Web_Sim_${Date.now()}.jpg`;
            link.href = dataURL;
            link.click();
        });

        initCamera();
    </script>
</body>
</html>

