<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IR Spectrum Assist Camera</title>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            font-family: monospace; 
            color: #0f0; /* 駭客風格綠色字體 */
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            padding: 10px;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            z-index: 20;
        }

        select {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            max-width: 150px;
        }

        /* 視窗區域 */
        .viewport {
            flex-grow: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* 預設無濾鏡 */
            filter: none; 
            transition: filter 0.3s;
        }

        /* 紅外線模式的 CSS 濾鏡模擬 */
        /* 去色 + 極高對比 + 拉高亮度 (模擬夜視鏡效果) */
        .ir-mode {
            filter: grayscale(100%) contrast(200%) brightness(150%) !important;
        }

        .controls {
            padding: 20px;
            background: #111;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            z-index: 20;
        }

        /* IR 開關 */
        .ir-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #333;
            padding: 5px 10px;
            border-radius: 20px;
            background: #000;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #f00;box-shadow: 0 0 10px #f00; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* 變焦 */
        input[type=range] {
            width: 90%;
            accent-color: #0f0;
        }

        .shutter-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: transparent;
            border: 4px solid #fff;
            position: relative;
            cursor: pointer;
        }
        .shutter-btn::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 56px; height: 56px;
            background: #fff;
            border-radius: 50%;
        }
        .shutter-btn:active::after { background: #aaa; transform: translate(-50%, -50%) scale(0.9); }

        #debug-text { font-size: 10px; color: #555; position: absolute; bottom: 5px; right: 5px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <select id="cameraSelect"><option>Loading...</option></select>
        <div class="ir-toggle">
            <span>IR 增強</span>
            <label class="switch">
                <input type="checkbox" id="irCheck">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="debug-text">Res: --</div>
    </div>

    <div class="controls">
        <div style="width:100%; display:flex; justify-content:space-between; font-size:12px;">
            <span>Zoom: <span id="zoomVal">1.0</span>x</span>
        </div>
        <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" disabled>
        
        <div class="shutter-btn" id="shutterBtn"></div>
    </div>
    
    <canvas id="photoCanvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const cameraSelect = document.getElementById('cameraSelect');
    const irCheck = document.getElementById('irCheck');
    const zoomSlider = document.getElementById('zoomSlider');
    const shutterBtn = document.getElementById('shutterBtn');
    const debugText = document.getElementById('debug-text');

    let currentStream = null;
    let videoTrack = null;
    let imageCapture = null;

    // 1. 初始化
    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop());
            
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            videoDevices.forEach(device => {
                const opt = document.createElement('option');
                opt.value = device.deviceId;
                opt.text = device.label || `Camera ${cameraSelect.length + 1}`;
                cameraSelect.appendChild(opt);
            });

            // 預設選最後一個 (通常是主鏡頭)
            if(videoDevices.length > 0) {
                cameraSelect.value = videoDevices[videoDevices.length - 1].deviceId;
                startCamera(cameraSelect.value);
            }

            cameraSelect.onchange = (e) => startCamera(e.target.value);

        } catch (e) {
            alert("請允許相機權限");
        }
    }

    // 2. 啟動相機
    async function startCamera(id) {
        if(currentStream) currentStream.getTracks().forEach(t => t.stop());

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    deviceId: { exact: id },
                    width: { ideal: 4096 },
                    height: { ideal: 4096 }
                }
            });
            
            currentStream = stream;
            video.srcObject = stream;
            videoTrack = stream.getVideoTracks()[0];
            
            if(window.ImageCapture) imageCapture = new ImageCapture(videoTrack);

            video.onloadedmetadata = () => {
                debugText.innerText = `Res: ${video.videoWidth}x${video.videoHeight}`;
                checkZoom();
            }
        } catch(e) {
            console.error(e);
        }
    }

    // 3. 變焦邏輯
    function checkZoom() {
        const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
        if(caps.zoom) {
            zoomSlider.disabled = false;
            zoomSlider.min = caps.zoom.min;
            zoomSlider.max = caps.zoom.max;
            zoomSlider.step = caps.zoom.step;
            zoomSlider.oninput = function() {
                videoTrack.applyConstraints({advanced: [{zoom: this.value}]});
                document.getElementById('zoomVal').innerText = parseFloat(this.value).toFixed(1);
            }
        } else {
            zoomSlider.disabled = true;
        }
    }

    // 4. IR 模式切換 (CSS 濾鏡模擬)
    irCheck.onchange = function() {
        if(this.checked) {
            video.classList.add('ir-mode');
        } else {
            video.classList.remove('ir-mode');
        }
    }

    // 5. 拍照 (會將 CSS 濾鏡效果「燒錄」進圖片)
    shutterBtn.onclick = async () => {
        const w = video.videoWidth;
        const h = video.videoHeight;
        const canvas = document.getElementById('photoCanvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');

        // 如果開啟 IR 模式，使用 Canvas 濾鏡處理
        if(irCheck.checked) {
            ctx.filter = 'grayscale(100%) contrast(200%) brightness(150%)';
        }
        
        ctx.drawImage(video, 0, 0, w, h);
        
        // 存檔
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `IR_PHOTO_${Date.now()}.png`; // 仍存為 PNG
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }, 'image/png');
    };

    init();

</script>
</body>
</html>

