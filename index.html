<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Lens Lab (Deep Fix)</title>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, monospace; color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        .top-bar { 
            background: #111; padding: 10px; border-bottom: 1px solid #333; z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        .row { display: flex; gap: 8px; align-items: center; }
        
        /* é¡é ­é¸å–® (é¡¯ç¤ºåŸå§‹åç¨±) */
        select { 
            background: #222; color: #0f0; border: 1px solid #444; padding: 8px; 
            border-radius: 4px; font-size: 12px; flex-grow: 1; font-family: monospace;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 8px 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 12px;
        }
        .btn-refresh { background: #444; }
        .btn-tele { background: linear-gradient(135deg, #ff9900, #ff5500); }
        .btn-wide { background: linear-gradient(135deg, #00d2ff, #0072ff); }

        .viewport { 
            flex-grow: 1; position: relative; background: #050505; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* é™¤éŒ¯è³‡è¨Š HUD */
        #debug-hud {
            position: absolute; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.7); padding: 8px; border-radius: 4px;
            pointer-events: none; max-width: 80%;
        }
        .log-line { font-size: 10px; color: #ccc; margin-bottom: 2px; }
        .log-success { color: #0f0; }
        .log-err { color: #f55; }
        .log-warn { color: #ff0; }

        .controls { 
            background: #111; padding: 20px; border-top: 1px solid #333; z-index: 20;
            display: flex; flex-direction: column; gap: 15px; align-items: center;
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        .slider-row { width: 100%; display: flex; align-items: center; gap: 10px; color: #ffd700; font-weight: bold; font-size: 14px;}
        input[type=range] { flex-grow: 1; accent-color: #ffd700; }

        .shutter {
            width: 70px; height: 70px; border-radius: 50%;
            border: 4px solid #fff; background: transparent;
            cursor: pointer; position: relative;
        }
        .shutter::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 58px; height: 58px; background: #fff; border-radius: 50%;
        }
        .shutter:active::after { background: #ccc; transform: translate(-50%, -50%) scale(0.9); }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="row">
            <select id="cameraSelect"><option>åˆå§‹åŒ–ä¸­...</option></select>
            <button class="btn-refresh" onclick="init()">â†» é‡æ•´</button>
        </div>
        <div class="row">
            <!-- å¼·åˆ¶åˆ‡æ›æŒ‰éˆ• -->
            <button class="btn-wide" onclick="forceZoom(0.5)" style="flex:1">å¼·åˆ¶å»£è§’ (0.5x)</button>
            <button class="btn-tele" onclick="forceZoom(2.0)" style="flex:1">å¼·åˆ¶é•·ç„¦ (2.0x)</button>
            <button class="btn-tele" onclick="forceZoom(3.0)" style="flex:1">å¼·åˆ¶é•·ç„¦ (3.0x)</button>
        </div>
    </div>

    <div class="viewport">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div id="debug-hud">
            <div class="log-line">ç³»çµ±å°±ç·’</div>
        </div>
    </div>

    <div class="controls">
        <div class="slider-row">
            <span>Zoom</span>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" disabled>
            <span id="zoomVal">1.0</span>
        </div>
        <div class="shutter" onclick="takePhoto()"></div>
    </div>

    <canvas id="canvas"></canvas>

<script>
    const video = document.getElementById('videoPreview');
    const cameraSelect = document.getElementById('cameraSelect');
    const hud = document.getElementById('debug-hud');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomVal = document.getElementById('zoomVal');
    
    let currentStream;
    let videoTrack;
    let imageCapture;

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = `log-line ${type}`;
        div.innerText = `> ${msg}`;
        hud.prepend(div); // æœ€æ–°è¨Šæ¯åœ¨æœ€ä¸Šé¢
        if(hud.children.length > 5) hud.lastChild.remove();
        console.log(msg);
    }

    // 1. åˆå§‹åŒ–ï¼šåˆ—å‡ºæ‰€æœ‰åŸå§‹è£ç½®
    async function init() {
        try {
            log("è«‹æ±‚æ¬Šé™ä¸­...");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => t.stop()); // æ‹¿åˆ°æ¬Šé™å¾Œé¦¬ä¸Šé—œæ‰ï¼Œé¿å…ä½”ç”¨

            log("åˆ—èˆ‰è£ç½®ä¸­...");
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            
            // ç›´æ¥é¡¯ç¤ºåŸå§‹æ¨™ç±¤ï¼Œä¸åšéæ¿¾ï¼Œç¢ºä¿æ‚¨èƒ½çœ‹åˆ°æ‰€æœ‰é¡é ­
            if(videoDevices.length === 0) {
                log("âŒ æ‰¾ä¸åˆ°ä»»ä½•é¡é ­", "log-err");
                return;
            }

            videoDevices.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                // é¡¯ç¤ºåŸå§‹ labelï¼Œæ–¹ä¾¿é™¤éŒ¯
                opt.text = `ID:${i} | ${d.label || 'Unknown Camera'}`;
                cameraSelect.appendChild(opt);
            });

            log(`æ‰¾åˆ° ${videoDevices.length} é¡†é¡é ­`, "log-success");
            
            // é è¨­é¸æœ€å¾Œä¸€é¡† (é€šå¸¸æ˜¯ä¸»æ”)
            const lastCam = videoDevices[videoDevices.length - 1];
            cameraSelect.value = lastCam.deviceId;
            startCamera(lastCam.deviceId);

            cameraSelect.onchange = (e) => startCamera(e.target.value);

        } catch(e) {
            log("âŒ æ¬Šé™è¢«æ‹’çµ•æˆ–éŒ¯èª¤: " + e.message, "log-err");
        }
    }

    // 2. å•Ÿå‹•ç›¸æ©Ÿï¼šæ¥µé™é™ç´šç­–ç•¥ (Deep Scan)
    async function startCamera(deviceId) {
        if(currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
            await new Promise(r => setTimeout(r, 200)); // ç­‰å¾…ç¡¬é«”é‡‹æ”¾
        }

        zoomSlider.disabled = true;
        log(`æ­£åœ¨å•Ÿå‹•é¡é ­...`);

        // å®šç¾©ç­–ç•¥ï¼šå¾ 4K ä¸€è·¯é™åˆ° VGA
        const strategies = [
            { label: "4K (4:3)", constraints: { width: { ideal: 4096 }, height: { ideal: 4096 }, aspectRatio: 1.333 } },
            { label: "4K (Any)", constraints: { width: { ideal: 4096 }, height: { ideal: 4096 } } },
            { label: "1080p",    constraints: { width: { ideal: 1920 }, height: { ideal: 1080 } } },
            { label: "2MP (4:3)",constraints: { width: { ideal: 1600 }, height: { ideal: 1200 }, aspectRatio: 1.333 } }, // è¼”åŠ©é¡é ­å¸¸ç”¨
            { label: "720p",     constraints: { width: { ideal: 1280 }, height: { ideal: 720 } } },
            { label: "VGA",      constraints: { width: { ideal: 640 }, height: { ideal: 480 } } },
            { label: "Safe Mode",constraints: {} } // ä¸è¨­é™ï¼Œæ±‚æœ‰ç•«é¢å°±å¥½
        ];

        for (const strategy of strategies) {
            try {
                log(`å˜—è©¦: ${strategy.label}...`);
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        ...strategy.constraints
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // æˆåŠŸç²å–ä¸²æµ
                currentStream = stream;
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                
                // ç­‰å¾…ç•«é¢è¼‰å…¥
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => resolve();
                    video.onerror = (e) => reject(e);
                    // 1ç§’è¶…æ™‚
                    setTimeout(() => reject(new Error("Timeout")), 1500);
                });

                // æª¢æŸ¥æ˜¯å¦é»‘å± (å¯¬åº¦æ˜¯å¦ç‚º0)
                if (video.videoWidth === 0) throw new Error("Black Screen (Width 0)");

                // ç²å–å¯¦éš›è§£æåº¦
                log(`âœ… æˆåŠŸ! Res: ${video.videoWidth}x${video.videoHeight}`, "log-success");
                
                // å•Ÿç”¨ ImageCapture
                if(window.ImageCapture) {
                    try { imageCapture = new ImageCapture(videoTrack); } catch(e){}
                }

                // æª¢æŸ¥è®Šç„¦èƒ½åŠ›
                checkCapabilities();
                
                return; // æˆåŠŸå°±è·³å‡ºè¿´åœˆ

            } catch(e) {
                log(`âŒ ${strategy.label} å¤±æ•—: ${e.message}`, "log-warn");
                if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
                // ç¹¼çºŒä¸‹ä¸€å€‹ç­–ç•¥
            }
        }
        
        log("âŒ æ‰€æœ‰æ¨¡å¼çš†å¤±æ•— (æ­¤é¡é ­å¯èƒ½ç„¡æ³•å­˜å–)", "log-err");
        alert("é€™é¡†é¡é ­ä¼¼ä¹ç„¡æ³•åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ï¼Œå¯èƒ½æ˜¯å°ˆç”¨æ„Ÿæ¸¬å™¨ (å¦‚æ™¯æ·±/ç´…å¤–ç·š)ã€‚");
    }

    function checkCapabilities() {
        const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
        
        if (caps.zoom) {
            zoomSlider.disabled = false;
            zoomSlider.min = caps.zoom.min;
            zoomSlider.max = caps.zoom.max; // é–‹æ”¾æœ€å¤§è®Šç„¦
            zoomSlider.step = 0.1;
            zoomSlider.value = 1; // é‡ç½®
            zoomVal.innerText = "1.0";
            
            log(`ğŸ” è®Šç„¦ç¯„åœ: ${caps.zoom.min}x - ${caps.zoom.max}x`, "log-success");
            
            zoomSlider.oninput = function() {
                const z = parseFloat(this.value);
                zoomVal.innerText = z.toFixed(1);
                videoTrack.applyConstraints({advanced: [{zoom: z}]}).catch(e=>{});
            };
        } else {
            zoomSlider.disabled = true;
            log("âš ï¸ æ­¤é¡é ­ä¸æ”¯æ´ Web è®Šç„¦", "log-warn");
        }
    }

    // 3. å¼·åˆ¶è®Šç„¦ (å–šé†’é•·ç„¦é¡é ­çš„é—œéµ)
    window.forceZoom = async function(factor) {
        if (!videoTrack) return log("ç›¸æ©Ÿæœªå•Ÿå‹•", "log-err");
        
        log(`å˜—è©¦å¼·åˆ¶åˆ‡æ›è‡³ ${factor}x ...`);
        try {
            // å…ˆæª¢æŸ¥æ˜¯å¦æ”¯æ´
            const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
            if (!caps.zoom) return log("âŒ ç¡¬é«”å›å ±ä¸æ”¯æ´è®Šç„¦", "log-err");
            
            // å¼·åˆ¶è¨­å®š
            await videoTrack.applyConstraints({ advanced: [{ zoom: factor }] });
            
            zoomSlider.value = factor;
            zoomVal.innerText = factor.toFixed(1);
            log(`âœ… å·²ç™¼é€ ${factor}x æŒ‡ä»¤`, "log-success");
            log("è«‹è§€å¯Ÿç•«é¢è¦–è§’æ˜¯å¦æ”¹è®Š");
            
        } catch(e) {
            log(`âŒ åˆ‡æ›å¤±æ•—: ${e.message}`, "log-err");
        }
    }

    async function takePhoto() {
        const canvas = document.getElementById('canvas');
        
        // å„ªå…ˆä½¿ç”¨ takePhoto
        if (imageCapture) {
            try {
                const blob = await imageCapture.takePhoto();
                const bmp = await createImageBitmap(blob);
                save(bmp);
                log("å·²æ‹æ” (High Quality)", "log-success");
                return;
            } catch(e) {
                log("HQ æ‹æ”å¤±æ•—ï¼Œè½‰ç”¨æˆªåœ–", "log-warn");
            }
        }
        
        // Fallback
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        save(canvas);
        log("å·²æ‹æ” (Screen Capture)", "log-success");
    }

    function save(source) {
        const c = document.getElementById('canvas');
        if(source !== c) {
            c.width = source.width; c.height = source.height;
            c.getContext('2d').drawImage(source,0,0);
        }
        const a = document.createElement('a');
        a.download = `Photo_${Date.now()}.jpg`;
        a.href = c.toDataURL('image/jpeg', 0.95);
        a.click();
    }

    init();
</script>
</body>
</html>


